extends ../layout

block content
  h1(style="justify-self: center;") Gestión de Pacientes

  .d-flex.justify-content-between.align-items-center
    .d-flex.justify-content-between.align-items-center.mt-3
      .btn-group
        a.btn.btn-outline-primary(
          href=`/pacientes?estado=todos&buscar=${buscar}`
          class=estado==="todos" ? "active" : ""
        ) Todos

        a.btn.btn-outline-success(
          href=`/pacientes?estado=activos&buscar=${buscar}`
          class=estado==="activos" ? "active" : ""
        ) Activos

        a.btn.btn-outline-secondary(
          href=`/pacientes?estado=inactivos&buscar=${buscar}`
          class=estado==="inactivos" ? "active" : ""
        ) Inactivos

    //- BUSCADOR
    form(method="GET" action="/pacientes" class="d-flex gap-2 mt-3")
      input.form-control(
        type="text"
        name="buscar"
        style="width: 300px;"
        placeholder="Buscar por nombre, apellido o DNI..."
        value=buscar
      )

      //- Mantener el filtro actual
      input(type="hidden" name="estado" value=estado)

      button.btn.btn-outline-primary(type="submit") Buscar

    if (['admin', 'recepcion'].includes(user.rol))
      button.btn.btn-success.mx-3.mt-3(
        type="button"
        data-bs-toggle="modal"
        data-bs-target="#modalCrearPaciente"
      ) + Nuevo Paciente

  table.table.table-striped.mt-3
    thead
      tr
        th ID
        th Nombre
        th DNI
        th Fecha de Nacimiento
        th Sexo
        th Teléfono
        th Dirección
        th Obra Social
        th Estado
        if (['admin', 'recepcion'].includes(user.rol))
          th Acciones
    tbody
      if pacientes.length > 0
        each p in pacientes
          tr
            td #{p.idPaciente}
            td #{p.nombre} #{p.apellido}
            td #{p.dni}
            td #{p.fechaNacimiento.toLocaleDateString("es-AR")}
            td #{p.sexo}
            td #{p.telefono}
            td #{p.direccion}
            td #{p.obraSocial || 'No especificada'}
            td 
              if p.visible > 0
                span.bg-success.text-white(style="padding: 4px 10px; border-radius: 5px;") Activo
              else 
                span.bg-secondary.text-white(style="padding: 4px 10px; border-radius: 5px;") Inactivo
            if (['admin', 'recepcion'].includes(user.rol))
              td
                if p.visible == 1
                  if p.nombre!="NN"
                    button.btn.btn-sm.btn-warning.mx-1(
                      type="button"
                      data-bs-toggle="modal"
                      data-bs-target="#modalEditarPaciente"
                      data-id=p.idPaciente
                      data-nombre=p.nombre
                      data-apellido=p.apellido
                      data-dni=p.dni
                      data-fecha=p.fechaNacimiento
                      data-sexo=p.sexo
                      data-telefono=p.telefono
                      data-direccion=p.direccion
                      data-obra=p.obraSocial
                    ) Editar
                  button.btn.btn-sm.btn-danger.mx-1(
                    type="button"
                    data-bs-toggle="modal"
                    data-bs-target="#modalBajaPaciente"
                    data-id=p.idPaciente
                    data-nombre=`${p.nombre} ${p.apellido}`
                  ) Dar de baja
                else
                  button.btnAltaPaciente.btn.btn-sm.btn-primary.mx-1(
                    data-id=p.idPaciente
                  ) Dar de Alta
      else
        tr
          td(colspan="10" class="text-center text-muted")
            | No se encontraron pacientes
  
  if totalPages > 1
    nav.mt-4
      ul.pagination
        each n in Array(totalPages).fill(0).map((_, i) => i + 1)
          li.page-item(class=page===n ? "active" : "")
            a.page-link(
              href=`/pacientes?estado=${estado}&buscar=${buscar}&page=${n}`
            ) #{n}
  
  if (['admin', 'recepcion'].includes(user.rol))
    //- MODAL CREAR PACIENTE
    #modalCrearPaciente.modal.fade(tabindex="-1" aria-hidden="true")
      .modal-dialog
        .modal-content
          .modal-header
            h5.modal-title Nuevo Paciente
            button.btn-close(type="button", data-bs-dismiss="modal")

          .modal-body
            form#formCrearPaciente
              .mb-3
                label.form-label Nombre
                input.form-control(name="nombre")

              .mb-3
                label.form-label Apellido
                input.form-control(name="apellido")

              .mb-3
                label.form-label DNI
                input.form-control(name="dni")

              .mb-3
                label.form-label Fecha de Nacimiento
                input.form-control(type="date" name="fechaNacimiento")

              .mb-3
                label.form-label Sexo
                select.form-control(name="sexo")
                  option(value="M") Masculino
                  option(value="F") Femenino

              .mb-3
                label.form-label Teléfono
                input.form-control(name="telefono")

              .mb-3
                label.form-label Dirección
                input.form-control(name="direccion")

              .mb-3
                label.form-label Obra Social
                input.form-control(name="obraSocial")

          .modal-footer
            button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancelar
            button.btn.btn-primary(type="submit" form="formCrearPaciente") Guardar

    //- MODAL EDITAR PACIENTE
    #modalEditarPaciente.modal.fade(tabindex="-1" aria-hidden="true")
      .modal-dialog
        .modal-content
          .modal-header
            h5.modal-title Editar Paciente
            button.btn-close(type="button", data-bs-dismiss="modal")

          .modal-body
            form#formEditarPaciente
              input(type="hidden" name="id")

              .mb-3
                label.form-label Nombre
                input.form-control(name="nombre")

              .mb-3
                label.form-label Apellido
                input.form-control(name="apellido")

              .mb-3
                label.form-label DNI
                input.form-control(name="dni")

              .mb-3
                label.form-label Fecha de Nacimiento
                input.form-control(type="date" name="fechaNacimiento")

              .mb-3
                label.form-label Sexo
                select.form-control(name="sexo")
                  option(value="M") Masculino
                  option(value="F") Femenino

              .mb-3
                label.form-label Teléfono
                input.form-control(name="telefono")

              .mb-3
                label.form-label Dirección
                input.form-control(name="direccion")

              .mb-3
                label.form-label Obra Social
                input.form-control(name="obraSocial")

          .modal-footer
            button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancelar
            button.btn.btn-primary(type="submit" form="formEditarPaciente") Guardar Cambios

    //- MODAL PARA CONFIRMAR LA BAJA LOGICA
    #modalBajaPaciente.modal.fade(tabindex="-1" aria-hidden="true")
      .modal-dialog
        .modal-content
          .modal-header
            h5.modal-title Dar de baja paciente
            button.btn-close(type="button", data-bs-dismiss="modal")

          .modal-body
            p Seguro que deseas dar de baja a:
              strong 
                span#nombrePaciente

          .modal-footer
            button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Cancelar
            button.btn.btn-danger#btnConfirmarBaja(type="button") Baja lógica

  script.
    document.addEventListener("DOMContentLoaded", () => {
      
      // --------- Limpiador de errores toast de los formularios ---------------
      activarLimpiadorErrores(document.querySelector("#formCrearPaciente"));
      activarLimpiadorErrores(document.querySelector("#formEditarPaciente"));

      // -------- QUITAR FOCUS DE MODALES SI SE OCULTAN --------
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener("hidden.bs.modal", () => {
          document.activeElement.blur();
          document.body.focus();
        });
      });

      // -------- CREAR PACIENTE --------
      const formCrear = document.getElementById("formCrearPaciente");

      if (formCrear) {
        formCrear.addEventListener("submit", async (e) => {
          e.preventDefault();
          removeToasts();

          const data = Object.fromEntries(new FormData(formCrear));

          const res = await fetch("/pacientes/crear", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
          });

          const json = await res.json();
          if (json.ok) location.reload();
          else {
            toast(json.error, formCrear[json.field], "error");
            return;
          }
        });
      }

      // -------- EDITAR PACIENTE --------
      const modalEditar = document.getElementById("modalEditarPaciente");
      const formEditar = document.getElementById("formEditarPaciente");

      if (modalEditar && formEditar) {
        modalEditar.addEventListener("show.bs.modal", (event) => {
          const button = event.relatedTarget;

          formEditar.id.value = button.dataset.id;
          formEditar.nombre.value = button.dataset.nombre;
          formEditar.apellido.value = button.dataset.apellido;
          formEditar.dni.value = button.dataset.dni;

          if (button.dataset.fecha)
            formEditar.fechaNacimiento.value = button.dataset.fecha.substring(0, 10);

          formEditar.sexo.value = button.dataset.sexo;
          formEditar.telefono.value = button.dataset.telefono;
          formEditar.direccion.value = button.dataset.direccion;
          formEditar.obraSocial.value = button.dataset.obra || "No especificada";
        });

        formEditar.addEventListener("submit", async (e) => {
          e.preventDefault();
          removeToasts();

          const data = Object.fromEntries(new FormData(formEditar));

          const res = await fetch(`/pacientes/editar/${data.id}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
          });

          const json = await res.json();
          if (json.ok) location.reload();
          else {
            toast(json.error, formEditar[json.field], "error");
            return;
          }
        });
      }

      // -------- BAJA PACIENTE --------
      const modalBaja = document.getElementById("modalBajaPaciente");
      const btnBaja = document.getElementById("btnConfirmarBaja");

      if (modalBaja && btnBaja) {
        modalBaja.addEventListener("show.bs.modal", (event) => {
          const button = event.relatedTarget; // botón que abrió el modal

          const id = button.dataset.id;
          const nombre = button.dataset.nombre;

          // Guardamos el ID en el botón de confirmar para usarlo luego
          btnBaja.dataset.id = id;

          // Mostrar el nombre del paciente en el texto del modal
          const nombreSpan = modalBaja.querySelector("#nombrePaciente");
          if (nombreSpan) {
            nombreSpan.textContent = nombre;
          }
        });

        btnBaja.addEventListener("click", async () => {
          
          const id = btnBaja.dataset.id;

          const res = await fetch(`/pacientes/baja/${id}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" }
          });

          const json = await res.json();

          if (json.ok) {
            location.reload(); // refrescar tabla
          } else {
            alert(json.error || "Error al dar de baja");
          }
        });
      }

      // -------- ALTA PACIENTE --------
      const botonesAlta = document.querySelectorAll(".btnAltaPaciente");

      botonesAlta.forEach(btn => {
        btn.addEventListener("click", async () => {

          const id = btn.dataset.id;

          const res = await fetch(`/pacientes/alta/${id}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" }
          });

          const json = await res.json();

          if (json.ok) location.reload();
          else alert(json.error || "Error al dar de alta");
        });
      });
    });